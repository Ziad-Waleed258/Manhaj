@model Manhaj.ViewModels.QuizWizardVM

@{
    ViewData["Title"] = "إنشاء اختبار جديد";
    Layout = "_DashboardLayout";
}

<section class="section" style="background: var(--background-gray); min-height: 80vh; padding: 40px 20px;">
    <div style="max-width: 900px; margin: 0 auto;">
        <div class="section-header">
            <h2 class="section-title">إنشاء اختبار جديد</h2>
            <p class="section-subtitle">خطوات إنشاء الاختبار</p>
        </div>

        <div class="dashboard-card">
            <!-- Progress Bar -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px; position: relative;">
                <div style="position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: #e0e0e0; z-index: 0;"></div>
                <div id="progress-line" style="position: absolute; top: 15px; right: 0; width: 0%; height: 2px; background: var(--primary-color); z-index: 0; transition: width 0.3s;"></div>
                
                <div class="step-indicator active" data-step="1">1</div>
                <div class="step-indicator" data-step="2">2</div>
                <div class="step-indicator" data-step="3">3</div>
            </div>

            <form asp-action="CreateWizard" method="post" id="wizard-form">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="LectureId" />
                <div asp-validation-summary="All" class="text-danger"></div>

                <!-- Step 1: Title -->
                <div class="wizard-step active" id="step-1">
                    <h3 style="margin-bottom: 20px;">عنوان الاختبار</h3>
                    <div style="margin-bottom: 20px;">
                        <label asp-for="Title" style="display: block; font-weight: 600; margin-bottom: 8px;">عنوان الاختبار</label>
                        <input asp-for="Title" class="form-input" style="width: 100%;" placeholder="مثال: اختبار الوحدة الأولى" required />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>
                    <div style="text-align: left;">
                        <button type="button" class="btn btn-primary" onclick="nextStep(2)">التالي</button>
                    </div>
                </div>

                <!-- Step 2: Questions -->
                <div class="wizard-step" id="step-2" style="display: none;">
                    <h3 style="margin-bottom: 20px;">إضافة الأسئلة</h3>
                    
                    <!-- Add Question Form -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                        <h4 style="margin-bottom: 15px;">سؤال جديد</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">نص السؤال</label>
                            <textarea id="q-content" class="form-input" style="width: 100%; min-height: 80px;"></textarea>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">النقاط</label>
                            <input type="number" id="q-points" class="form-input" style="width: 100%;" value="1" step="0.5" min="0.5" />
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">الخيارات (اختر الإجابة الصحيحة)</label>
                            <div id="q-options-container" style="display: flex; flex-direction: column; gap: 10px;">
                                <div class="option-row" style="display: flex; align-items: center; gap: 10px;">
                                    <input type="radio" name="correct-answer" value="0" style="width: 20px; height: 20px;" />
                                    <input type="text" class="form-input q-option" placeholder="الخيار 1" style="flex: 1;" />
                                </div>
                                <div class="option-row" style="display: flex; align-items: center; gap: 10px;">
                                    <input type="radio" name="correct-answer" value="1" style="width: 20px; height: 20px;" />
                                    <input type="text" class="form-input q-option" placeholder="الخيار 2" style="flex: 1;" />
                                </div>
                            </div>
                            <button type="button" onclick="addOptionInput()" class="btn btn-outline" style="margin-top: 10px; font-size: 12px;">+ إضافة خيار</button>
                        </div>

                        <button type="button" onclick="addQuestionToList()" class="btn btn-primary" style="width: 100%;">إضافة للقائمة</button>
                    </div>

                    <!-- Questions List -->
                    <div id="questions-list" style="margin-bottom: 20px;">
                        <!-- Questions will be added here -->
                    </div>
                    
                    <!-- Hidden Container for Form Submission -->
                    <div id="hidden-questions-container"></div>

                    <div style="display: flex; justify-content: space-between;">
                        <button type="button" class="btn btn-outline" onclick="prevStep(1)">السابق</button>
                        <button type="button" class="btn btn-primary" onclick="nextStep(3)">التالي</button>
                    </div>
                </div>

                <!-- Step 3: Times -->
                <div class="wizard-step" id="step-3" style="display: none;">
                    <h3 style="margin-bottom: 20px;">توقيت الاختبار</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label asp-for="StartTime" style="display: block; font-weight: 600; margin-bottom: 8px;">وقت البدء</label>
                        <input asp-for="StartTime" class="form-input" type="datetime-local" style="width: 100%;" required value="" />
                        <span asp-validation-for="StartTime" class="text-danger"></span>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label asp-for="EndTime" style="display: block; font-weight: 600; margin-bottom: 8px;">وقت الانتهاء</label>
                        <input asp-for="EndTime" class="form-input" type="datetime-local" style="width: 100%;" required value="" />
                        <span asp-validation-for="EndTime" class="text-danger"></span>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label asp-for="Duration" style="display: block; font-weight: 600; margin-bottom: 8px;">المدة (بالدقائق)</label>
                        <input asp-for="Duration" class="form-input" type="number" style="width: 100%;" min="1" required />
                        <span asp-validation-for="Duration" class="text-danger"></span>
                    </div>

                    <div style="display: flex; justify-content: space-between;">
                        <button type="button" class="btn btn-outline" onclick="prevStep(2)">السابق</button>
                        <button type="submit" class="btn btn-primary">إنشاء الاختبار</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<style>
    .step-indicator {
        width: 30px;
        height: 30px;
        background: #e0e0e0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #666;
        z-index: 1;
        transition: all 0.3s;
    }
    .step-indicator.active {
        background: var(--primary-color);
        color: white;
    }
</style>

<script>
    let currentStep = 1;
    let questions = [];

    function nextStep(step) {
        // Validation for Step 1
        if (step === 2) {
            const title = document.getElementById('Title').value;
            if (!title) {
                alert('يرجى إدخال عنوان الاختبار');
                return;
            }
        }

        // Validation for Step 2
        if (step === 3) {
            if (questions.length === 0) {
                alert('يرجى إضافة سؤال واحد على الأقل');
                return;
            }
        }

        showStep(step);
    }

    function prevStep(step) {
        showStep(step);
    }

    function showStep(step) {
        document.querySelectorAll('.wizard-step').forEach(el => el.style.display = 'none');
        document.getElementById('step-' + step).style.display = 'block';
        
        // Update indicators
        document.querySelectorAll('.step-indicator').forEach(el => {
            if (parseInt(el.dataset.step) <= step) {
                el.classList.add('active');
            } else {
                el.classList.remove('active');
            }
        });

        // Update progress line
        const progress = ((step - 1) / 2) * 100;
        document.getElementById('progress-line').style.width = progress + '%';
        
        currentStep = step;
    }

    function addOptionInput() {
        const container = document.getElementById('q-options-container');
        const count = container.children.length;
        const div = document.createElement('div');
        div.className = 'option-row';
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.gap = '10px';
        div.style.marginTop = '10px';
        
        div.innerHTML = `
            <input type="radio" name="correct-answer" value="${count}" style="width: 20px; height: 20px;" />
            <input type="text" class="form-input q-option" placeholder="الخيار ${count + 1}" style="flex: 1;" />
        `;
        container.appendChild(div);
    }

    function addQuestionToList() {
        const content = document.getElementById('q-content').value;
        const points = document.getElementById('q-points').value;
        
        // Get options
        const optionInputs = document.querySelectorAll('.q-option');
        const options = [];
        optionInputs.forEach(input => {
            if (input.value.trim()) options.push(input.value.trim());
        });

        // Get correct answer from radio
        const selectedRadio = document.querySelector('input[name="correct-answer"]:checked');
        
        // Validation
        if (!content || options.length < 2) {
            alert('يرجى ملء نص السؤال وإضافة خيارين على الأقل');
            return;
        }

        if (!selectedRadio) {
            alert('يرجى اختيار الإجابة الصحيحة');
            return;
        }

        const selectedIndex = parseInt(selectedRadio.value);
        // We need to map the radio index to the actual options array index
        // Because some inputs might be empty and filtered out
        // But here we're pushing only trimmed values. 
        // Let's get the value directly from the input next to the radio
        const selectedInput = selectedRadio.nextElementSibling;
        const trueAnswer = selectedInput.value.trim();

        if (!trueAnswer) {
            alert('الإجابة الصحيحة المختارة فارغة');
            return;
        }

        // Add to array
        const question = {
            content,
            points,
            trueAnswer,
            options
        };
        questions.push(question);

        // Render list
        renderQuestionsList();
        
        // Clear form
        document.getElementById('q-content').value = '';
        document.getElementById('q-options-container').innerHTML = `
            <div class="option-row" style="display: flex; align-items: center; gap: 10px;">
                <input type="radio" name="correct-answer" value="0" style="width: 20px; height: 20px;" />
                <input type="text" class="form-input q-option" placeholder="الخيار 1" style="flex: 1;" />
            </div>
            <div class="option-row" style="display: flex; align-items: center; gap: 10px;">
                <input type="radio" name="correct-answer" value="1" style="width: 20px; height: 20px;" />
                <input type="text" class="form-input q-option" placeholder="الخيار 2" style="flex: 1;" />
            </div>
        `;
    }

    function removeQuestion(index) {
        questions.splice(index, 1);
        renderQuestionsList();
    }

    function renderQuestionsList() {
        const listContainer = document.getElementById('questions-list');
        const hiddenContainer = document.getElementById('hidden-questions-container');
        
        listContainer.innerHTML = '';
        hiddenContainer.innerHTML = '';

        questions.forEach((q, index) => {
            // Visual Item
            const item = document.createElement('div');
            item.style.background = 'white';
            item.style.padding = '15px';
            item.style.borderRadius = '8px';
            item.style.marginBottom = '10px';
            item.style.border = '1px solid #ddd';
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.style.alignItems = 'center';
            
            item.innerHTML = `
                <div>
                    <p style="font-weight: 600; margin: 0;">${q.content}</p>
                    <small style="color: #666;">${q.options.length} خيارات | ${q.points} نقاط | الإجابة: ${q.trueAnswer}</small>
                </div>
                <button type="button" onclick="removeQuestion(${index})" class="btn btn-outline" style="color: #dc3545; border-color: #dc3545; padding: 5px 10px;">حذف</button>
            `;
            listContainer.appendChild(item);

            // Hidden Inputs for MVC Binding
            hiddenContainer.innerHTML += `
                <input type="hidden" name="Questions[${index}].Content" value="${q.content}" />
                <input type="hidden" name="Questions[${index}].TrueAnswer" value="${q.trueAnswer}" />
                <input type="hidden" name="Questions[${index}].Points" value="${q.points}" />
            `;
            
            q.options.forEach((opt, optIndex) => {
                hiddenContainer.innerHTML += `
                    <input type="hidden" name="Questions[${index}].Options[${optIndex}]" value="${opt}" />
                `;
            });
        });
    }
</script>
